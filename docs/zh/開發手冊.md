# ClinePower 開發手冊

> 本手冊適用對象：想要貢獻新技能、修改現有技能、或了解 ClinePower 內部架構的開發者

---

## 系統架構

### 目錄結構

```
clinepower/
├── skills/                         # 所有技能的主目錄
│   ├── brainstorming/
│   │   └── SKILL.md
│   ├── test-driven-development/
│   │   ├── SKILL.md
│   │   └── testing-anti-patterns.md   # 輔助參考文件
│   ├── systematic-debugging/
│   │   ├── SKILL.md
│   │   ├── root-cause-tracing.md
│   │   ├── defense-in-depth.md
│   │   └── condition-based-waiting.md
│   ├── using-clinepower/
│   │   └── SKILL.md               # Bootstrap 技能（核心）
│   └── writing-skills/
│       ├── SKILL.md
│       └── testing-skills-with-subagents.md
├── .claude-plugin/                 # Claude Code 整合
│   ├── plugin.json
│   └── marketplace.json
├── .cursor-plugin/                 # Cursor 整合
│   └── plugin.json
├── .cline/                         # Cline 整合
│   └── INSTALL.md
├── .codex/                         # Codex 整合
│   └── INSTALL.md
├── .opencode/                      # OpenCode 整合
│   ├── INSTALL.md
│   └── plugins/clinepower.js
├── docs/
│   ├── zh/                         # 中文文件
│   ├── README.codex.md
│   ├── README.opencode.md
│   └── testing.md
└── tests/
    └── claude-code/                # 整合測試
        ├── test-helpers.sh
        ├── test-subagent-driven-development-integration.sh
        └── analyze-token-usage.py
```

### 核心組件

#### 1. Bootstrap 技能（`using-clinepower`）

這是整個系統的入口點。它的職責：
- 告訴 Agent 在每次回應前都要檢查是否有適用的技能
- 說明如何在不同平台上呼叫技能（`Skill` tool、`use_skill` tool 等）
- 定義技能優先順序（流程技能先於實作技能）

**此技能在每次對話時都會被載入。**

#### 2. Skill 技能載入機制（依平台）

| 平台 | 載入方式 | 技能儲存路徑 |
|---|---|---|
| Claude Code | 原生 `Skill` tool，按需載入 | Plugin 目錄 |
| Cursor | Plugin marketplace | Plugin 目錄 |
| Cline | 原生 `use_skill` tool，按需載入 | `~/.agents/skills/` 或 `~/.cline/skills/` |
| Codex | 原生 skill discovery，按需載入 | `~/.agents/skills/` |
| OpenCode | JS plugin hook 注入系統提示 | `~/.config/opencode/skills/` |

所有平台的技能格式相同（SKILL.md + YAML frontmatter），差別只在觸發工具名稱。

---

## SKILL.md 格式規範

### 基本結構

```markdown
---
name: skill-name-with-hyphens
description: Use when [具體觸發條件] - 以 "Use when" 開頭，不超過 1024 字元
---

# Skill 標題

## Overview
一句話說明這個技能是什麼，以及核心原則。

## When to Use
（可選）決策樹，使用 graphviz dot 格式的流程圖。

## The Process
主要流程說明。

## Common Mistakes
常見錯誤與修正方式。

## Red Flags
讓 Agent 知道何時應該停下來的警示清單。
```

### Frontmatter 規則

```yaml
---
name: my-skill-name          # 只能用字母、數字、連字號
description: Use when ...    # 第三人稱，描述觸發條件（不是描述流程）
---
```

**Description 的寫法：**

```yaml
# ❌ 錯誤：描述了流程步驟
description: Use for TDD - write test first, watch fail, write code, refactor

# ❌ 錯誤：太抽象
description: For testing

# ✅ 正確：描述觸發條件
description: Use when implementing any feature or bugfix, before writing implementation code
```

> **為什麼不能描述流程？** 如果 description 包含流程摘要，Agent 可能只看 description 就「照著做」，而跳過讀取完整的 SKILL.md 內容。這會導致遺漏重要細節。

### 輔助文件

當某部分內容很長（100+ 行）或需要重複使用時，可以拆出獨立檔案：

```
systematic-debugging/
  SKILL.md                    # 主要技能文件
  root-cause-tracing.md       # 根因追蹤技術（100+ 行，拆出）
  defense-in-depth.md         # 深度防禦技術
  condition-based-waiting.md  # 條件等待技術
```

SKILL.md 中引用方式：

```markdown
See `root-cause-tracing.md` in this directory for the complete backward tracing technique.
```

> **不要用 `@` 語法強制載入**：`@skills/path/file.md` 會立即把整個文件塞進 context，大量消耗 token。改用文字描述讓 Agent 按需讀取。

---

## 建立新技能

### 流程（TDD 應用於文件）

建立技能和寫程式一樣，遵循 RED-GREEN-REFACTOR：

**RED（基線測試）**
1. 找一個 Agent 實例，不給它這個技能
2. 描述你想讓它遵守的情境
3. 記錄它「自然」的行為——它會用什麼理由跳過你想要的做法？

**GREEN（寫技能）**
1. 針對你觀察到的行為偏差撰寫技能
2. 再次測試，確認 Agent 現在遵守
3. 如果仍有問題，調整技能

**REFACTOR（堵住漏洞）**
1. 試圖找出新的理由讓 Agent 跳過規則
2. 把這些理由加入「常見藉口」表格
3. 重複直到技能夠健全

### 技能類型

| 類型 | 說明 | 範例 |
|---|---|---|
| **紀律型** | 強制執行規則 | TDD、verification-before-completion |
| **技術型** | 教學具體技術 | condition-based-waiting、root-cause-tracing |
| **模式型** | 提供思維模型 | systematic-debugging |
| **參考型** | API 文件、指令參考 | API 文件技能 |

### 技能放置位置

| 位置 | 適用範圍 | 路徑 |
|---|---|---|
| 本 repo | 所有 ClinePower 使用者 | `skills/<name>/SKILL.md` |
| 個人技能（Claude Code） | 僅你自己 | `~/.claude/skills/<name>/SKILL.md` |
| 個人技能（Cline / Codex） | 僅你自己 | `~/.agents/skills/<name>/SKILL.md` |
| 專案技能（Cline） | 僅此專案 | `.cline/skills/<name>/SKILL.md` |
| 專案技能（Claude Code） | 僅此專案 | `.claude/skills/<name>/SKILL.md` |

### 技能中引用其他技能

```markdown
# ✅ 正確
**REQUIRED SUB-SKILL:** Use clinepower:test-driven-development

# ❌ 錯誤（會強制載入整個文件）
@skills/test-driven-development/SKILL.md
```

---

## 跨平台技能設計原則

ClinePower 的技能設計為平台無關（platform-agnostic），但有些工具呼叫語法是平台特定的。`using-clinepower/SKILL.md` 以每個平台的段落來處理：

```markdown
**In Claude Code:** Use the `Skill` tool. ...
**In Cline:** Use the `use_skill` tool. ...
**In other environments:** Check your platform's documentation.
```

撰寫技能內容時，工作流程說明（TDD 流程、除錯步驟）應保持平台無關；只有「呼叫工具」的部分才需要區分平台。

---

## 測試技能

### 整合測試（Claude Code）

```bash
cd tests/claude-code
./test-subagent-driven-development-integration.sh
```

需求：
- 從 clinepower 目錄執行
- `~/.claude/settings.json` 中有 `"clinepower@clinepower-dev": true`
- Claude Code 已安裝

### Token 分析

```bash
python3 tests/claude-code/analyze-token-usage.py \
  ~/.claude/projects/<project-dir>/<session-id>.jsonl
```

輸出每個子 Agent 的 token 用量，幫助評估效能與成本。

### 手動測試技能

以 Claude Code 為例：
1. 開啟新對話
2. 輸入：「do you have clinepower?」
3. 如果 Agent 回答說它知道哪些技能可用，安裝成功
4. 輸入符合技能描述的觸發情境，觀察 Agent 是否正確載入技能

---

## 貢獻流程

1. Fork 這個 repository
2. 建立一個新分支
3. 遵循 `writing-skills` 技能的流程建立並測試你的技能
4. 提交 Pull Request

### PR 提交前檢查

- [ ] SKILL.md 有正確的 YAML frontmatter（`name`、`description`）
- [ ] `description` 以 "Use when" 開頭，描述觸發條件而非流程
- [ ] 技能在不同壓力情境下都能讓 Agent 正確遵守
- [ ] 如有輔助文件，使用文字引用而非 `@` 強制載入
- [ ] 技能內容平台無關（除了工具呼叫語法）

---

## 加入新平台支援

要新增對某個 AI Agent 平台的支援，需要：

1. **確認技能格式相容性**
   - 該平台是否支援 YAML frontmatter 的 `name`/`description` 字段？
   - 是否有原生的技能載入工具？

2. **建立安裝指引**
   - 在 repo 根目錄建立 `.<platform>/INSTALL.md`
   - 說明如何連結 `skills/` 目錄到該平台的技能發現路徑

3. **更新 `using-clinepower/SKILL.md`**
   - 在「How to Access Skills」區段加入該平台的工具呼叫語法

4. **更新 `writing-skills/SKILL.md`**
   - 在個人技能路徑清單中加入該平台的路徑

5. **（選用）建立詳細文件**
   - 在 `docs/` 新增 `README.<platform>.md`

### Cline 整合作為參考範例

本 fork 新增的 Cline 支援可作為參考：
- `.cline/INSTALL.md` — 安裝指引
- `CHANGES-cline.md` — 變更紀錄
- `skills/using-clinepower/SKILL.md` — 新增 Cline 的工具說明

---

## 版本與更新

### Claude Code
```bash
/plugin update clinepower
```

### Cline / Codex（手動安裝）
```bash
cd ~/.cline/clinepower && git pull   # 或對應的安裝目錄
```

技能透過 symlink 連結，`git pull` 後立即生效，無需重新安裝。

---

## 聯絡

- **Issues**：https://github.com/obra/clinepower/issues
- **作者**：Jesse Vincent (jesse@fsck.com)
